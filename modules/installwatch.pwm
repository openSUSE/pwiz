#! /bin/bash

case $1 in
    desc )
	echo "installwatch module"
	return
	;;
    longdesc )
	echo "This module is able to collect file list information collected by installwatch during install process."
	return
	;;
    init )
	pwiz_module_needs filelist
	pwiz_phase_add_callme SOURCE
	filelist_raw_provider
	;;
    SOURCE )
	pwiz_phase_add SOURCE "mkdir -p $PWIZ_TMPDIR/installwatch"
	return
	;;
    filelist_raw )
	filelist_raw_open
	installwatch_IFS_save="$IFS"
	IFS=$'\t\n'
	for installwatch_stage in $PWIZ_TMPDIR/installwatch/* ; do
	    exec 3<$installwatch_stage
	    while read -u3 installwatch_a1 installwatch_a2 installwatch_a3 installwatch_a4 ; do
		case "$installwatch_a2" in
		    open )
			echo "$installwatch_a3" file
			;;
# FIXME: special tags for links
		    symlink | link )
			echo "$installwatch_a4" file
			;;
		    mkdir )
			echo "$installwatch_a3" dir
			;;
		esac
	    done
	    exec 3<&-
# installwatch works incorrectly for SUID and statically linked binaries (e. g. ldconfig).
# we need to combine it with simple find
	done
	IFS="$installwatch_IFS_save"
	# no callback needed, default echo does the right thing
	pwiz_find_d $PWIZ_INSTALLROOT
	filelist_raw_close
	return
	;;
    version )
	echo "0.1"
	return
	;;
    * )
	return
	;;
esac

function installwatch_run_wrapper {
    local LD_PRELOAD_save
#    installwatch -o $PWIZ_TMPDIR/installwatch/$PWIZ_PHASE_CURRENT$PWIZ_STAGE_CURRENT "$@"
    LD_PRELOAD_save="$LD_PRELOAD"
    export INSTW_LOGFILE=$PWIZ_TMPDIR/installwatch/$PWIZ_PHASE_CURRENT$PWIZ_STAGE_CURRENT
    export LD_PRELOAD="$LD_PRELOAD /usr/lib/installwatch.so"
    pwiz_run_wrap "$@"
    export LD_PRELOAD="$LD_PRELOAD_save"
}
